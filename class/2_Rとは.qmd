---
title: 2 分析環境の構築
---

# Rについて

## Rとは

Rは，統計分析に強みを持つコンピュータ言語です（統計ソフトと呼ぶこともあるけど，厳密な違いはよくわかりません）。

## 他のソフト・方法との比較

エクセルでもある程度の分析はできますが，覚えさえすればエクセルよりもはるかに簡単です。また，エクセルでできる分析は限られていますが，Rではそれよりもはるかに高度なことができます。また，エクセルはそもそも表計算ソフトです。データが簡単にいじれてしまう（書き換えられてしまう）状態で分析作業をするのは好ましくありません。

なんといってもフリーです。個人のコンピューター（職場が許すのであれば職場のコンピューターにも）にダウンロードすれば，卒業後も使えます。対してIBM社のSPSSは非常に高額です。研究者にでもならない限り個人で購入することはないでしょうし，職場で予算を取ることも難しいかもしれません。

機械学習との絡みでPythonが流行ってきています。ただ，統計分析に関してはRに一日の長があるという印象です。Pythonはなんでも出来るけど，統計分析部分の操作性・拡張性はRの方が良さそう。

コンピュータ言語のとっかかりはRでも，Rを使えるようになったらPythonもそこまで負担なく覚えられるでしょう。

![](images/paste-500C5DF1.png)

## Rstudio

Posit社の提供する統合開発環境（IDE）。RはそれだけだとWindowsのconsoleとか，Macのterminalみたいな，コマンドだけの画面

![](images/Screenshot%202022-11-27%20at%2016.45.48.png)

これで使えないわけでもなけれど，もっと使いやすい方が良い。Rをもっと使いやすい状態にしてくれるアプリがRstudioです。

-   Rの画面（左下）

-   Rのプログラムを書くスペース（左上）

-   読み込んだデータや，過去に実行したコマンドが見れるスペース（右上）

-   パッケージやファイル，作った図表などがみれるスペース（右下）

![](images/Screenshot%202022-11-27%20at%2016.48.01.png)

-   Rstudioを使うと，分析結果レポートを文書やプレゼン用スライドに直接書き出すこともできます。

    -   いまこの資料もRstudioで書いています。

-   文献リストの挿入などの機能も実装できるので，その気になればデータ分析から論文執筆まで全てRstudioでできます。

Google colabなど，他の開発環境もありますが，インストールさえしてしまえば，Rstudioの方が便利だと思います。

# RとRstudioのインストール

## Rのインストール

1.  R の公式サイトに行く<https://cloud.r-project.org>
2.  自分のOSに合ったものを選択
    -   Windowsなら `Download R for Windows`
        -   Base を選ぶ
    -   Macなら`Download R for macOS`
        -   Sliconなら`R-X.X.X-arm64.pkg`，Intelなら`R-X.X.X.pkg`
3.  ダウンロードしたものを実行してインストール

## Rstudioのインストール

1.  RStudio の公式サイトに行く<https://posit.co/products/open-source/rstudio/>
2.  無料版（Open Source Edition）を選択
3.  自分のOSに合ったものを選んでダウンロード
4.  ダウンロードしたものを実行してインストール

::: {.callout-note appearance="minimal" icon="false"}
X.X.X という部分はバージョン番号です。
:::

# Rの操作

## スクリプトファイル

Rなどの統計ソフトを使う利点の一つは，再現性です。例えばエクセルでは，どんな順番にどんな処理をしたのかは記録されません。Rなどのプログラミングソフトを使うと，操作した内容と順番をコードの形で記録しておけます。コードを記録したファイルを「**スクリプトファイル**」と言います。

スクリプトファイルは，画面左上にある緑の「＋」アイコンを押して，「R Script」を選択することで新規作成できます。

![](images/Screenshot%202022-11-27%20at%2017.27.05.png)

スクリプトファイルを作成すると（初期状態では）画面の左上に白紙のファイルが出てきます。ここにコマンドを打ち込んでいきます。例えば以下のコマンドを打つと，画面の左下にあるRの画面に実行結果が出ます。

```{r}
1 + 1
```

::: {.callout-note appearance="minimal" icon="false"}
左下の画面（console）に直接 `1+1` と打ち込んでも同じ結果が出ますが，後で記録に残らないので，**コードはスクリプト画面に書く**，**左下は結果の表示だけ**，と使い分けた方が良いです。
:::

![](images/Screenshot%202022-11-27%20at%2017.27.34.png)

## 課題

### 算術演算子

Rスクリプトに以下の内容を打ち込んでください。スクリプト右上の*Run*ボタンを押すか，`Control + Enter` (Macの場合は`⌘+Enter`)で実行してください。

```{r, 算術}
1+3 #<1>
2*4 #<2>
4-2 #<3>
4/2 #<4>
2^4 #<5>
sqrt(16) #<6>
```

1.  足し算( `+` )
2.  掛け算( `*` )
3.  引き算( `-` )
4.  割り算 ( `/` )
5.  累乗（ `^`）
6.  ルート（ `sqrt()` )

### 論理演算子

論理演算子（`>, ==, !=` など）は，真（TRUE) か偽（FALSE）を返す。

```{r}
9 > 9
9 >= 9
'egg' == 'egg'
'apple' != 'apple'
```

# Rプログラミングの基礎

::: {.callout-note appearance="minimal" icon="false"}
このパートは森知晴先生（立命館大学総合心理学部）のサイト ([卒業論文のためのR入門](https://tomoecon.github.io/R_for_graduate_thesis/)) 及び今井耕介先生（Harvard University / 東京大学）の著書 ([社会科学のためのデータ分析入門](https://www.amazon.co.jp/社会科学のためのデータ分析入門-上-今井-耕介/dp/400061245X/ref=sr_1_1?adgrpid=54784895673&gclid=Cj0KCQiAsoycBhC6ARIsAPPbeLtObkhBeqit6O7Sj3q8D_1rpHAI9W9AMQGvb1vkBj_Hx92oiJMxrAoaAp4OEALw_wcB&hvadid=611396736239&hvdev=c&hvlocphy=1009565&hvnetw=g&hvqmt=e&hvrand=10303375646734173109&hvtargid=kwd-418130371895&hydadcr=4077_13255612&jp-ad-ap=0&keywords=社会科学のためのデータ分析入門&qid=1669555883&qu=eyJxc2MiOiIyLjAwIiwicXNhIjoiMS44MyIsInFzcCI6IjEuNzMifQ%3D%3D&sr=8-1))等を参考にしています。
:::

## オブジェクト

Rでは情報を自分で名前をつけたオブジェクトとして保存できます。Rstudioでは，保存されたオブジェクトは右上のEnvironmentと言うところに表示されます。

```{r}
x <- 1
```

「`<-`」の左はオブジェクト，右はその中身を表します。なので，「xという名前のオブジェクトに1を入れる」という指示をしています。これを実行すると画面右上にxというオブジェクトが表示されるはずです。xの中身を確認するには，そのオブジェクトの名前（今回の場合`x`）を打つと良いです。

```{r}
x
```

これを応用して変数を先に定義して，計算。

```{r}
#printで表示
x <- 3
y <- 5
z <- x * y
print(z) #<1>
```

1.  `z` を表示するコマンド。ただし，`print()`を省略して単に`z`と打っても同じ。

文字列でもオブジェクトになります。

```{r}
univ <- "Ritsumeikan University"
univ

```

::: callout-tip
変数名はあとで見返してもわかる名前をつけましょう。`x`とか`a`とかつけるとあとでわからなくなります。例えば英語と算数のテストの点があるなら，`english`と`math`と名付けるなど。
:::

複数の数値の並び（ベクトル）をオブジェクトとすることもできます。

```{r}
vec <- c(1, 2, 3, 4, 5)
```

縦×横の行列も作れます。matrixという名前です。`ncol=2`は列の数, `byrow=TRUE`は，横に並べるということ。

```{r}
mat <- matrix(c(435,165,265,135), ncol=2, byrow=TRUE)
mat

```

例えば`byrow=FALSE` にすると縦に並ぶ

```{r}
mat2 <- matrix(c(435,165,265,135), ncol=2, byrow=FALSE)
mat2
```

縦横の名前をつけると

```{r}
rownames(mat) <- c("行1", "行2")
colnames(mat)<- c("列1", "列2")
mat
```

## データフレーム

オブジェクトの中で重要な形式として，データフレームがあります。これは，縦方向に観測値を、横方向に変数を並べたデータを言います。

```{r}
age <- c(18, 21, 22, 23, 34) #年齢のベクトル
gender <- c("female", "male", "male", "female", "female")#性別のベクトル
dframe <- data.frame(age, gender)
dframe
```

エクセル等のデータを読み込んで分析する場合は，このデータフレーム形式です。

データフレームの中の特定の行を指定する場合は，「`データフレーム名$列名`」

```{r}
dframe$gender
```

## 関数

Rを使う上で最も重要。何がしかの命令をすると，何かの結果が返ってくる。

```{r}
mean(dframe$age) #<1>
min(dframe$age) #<2>
median(dframe$age) #<3>
```

1.  平均は`mean()`
2.  最小値（最大値）は`min()` (`max()`)
3.  中央値は`median()`

上にあるように，Rのコマンドは基本的には，`やること(実行する対象)`という構造になっている。

-   `mean(dframe$age)`は，

    -   やることが平均(`mean`)

    -   対象がデータフレームdframeのなかのage (`dframe$age`)

## プログラムの改行

Rではかっこ()やコンマ（,）の後など，コードの切れ目で開業しても動作します。特に()何重にもなる場合，改行したほうが見やすいかもしれません。例えば，上でやった行列の作成コマンド

```{r}
mat <- matrix(c(435,165,265,135), ncol=2, byrow=TRUE)
```

は，以下のように書いても全く同じように動作します。

```{r}
mat <- matrix(
  c(435,165,265,135), 
  ncol=2, 
  byrow=TRUE
  )
```

これでも同じですが，あまり改行しすぎるのもかえって読みにくいかもしれません。自分が見やすいように程よく改行してください。

```{r}
mat <- 
  matrix(
  c(
    435,
    165,
    265,
    135
    ), 
  ncol=2, 
  byrow=TRUE
  )
```

# 分析のための準備

## パッケージ

Rはそのままでもある程度のことができますが，より高度なことをしたり，同じことをより簡単にしたりするために追加の機能を足すことができます。この追加の機能はパッケージと言います。

::: {.callout-note appearance="minimal" icon="false"}
RがスマートフォンのOSのようなもので，パッケージはアプリのようなもの。iOSやAndroidは，そのままでも色々できるけれど，アプリを入れた方が便利。
:::

Rのプログラムを格段にわかりやすくするパッケージであるtidyverseを使う準備をしてみます。パッケージは，最初に使う時にはインストールする必要があります（これは1回だけ。App Storeでアプリをとるような感じ）。

```{r}
#| eval: false 
install.packages(tidyverse)

```

パッケージを使う時には，分析ファイルを実行する最初の段階で以下のコマンドを使います（スマートフォンにすでに入っているアプリを開くイメージ）。

```{r}
#| message: false
library(tidyverse)
```

後で使うので，以下のパッケージも読み込んでおきます。

```{r}
#| message: false
library(magrittr)
library(googledrive)
```

## Working Directoryの設定

次に，Rが作業する場所（wd）を設定します。これは次で読み込むデータが保存されていたり，プログラムの中で生成したデータが保存されたりする場所です。

パソコン上の場所をうまく指定できるのであれば，以下のようにコマンドを打てば良い です(下はMacでデスクトップをwdにした例)

```{r}
#| eval: false 
setwd("~/Desktop")
```

場所の指定がうまくできない場合，Rstudio右下の箱の `Files`タブから指定したいフォルダを選び，⚙マークから「Set As Working Directory」を選ぶことで，コマンドを実行してくれます (その後実行されたコマンドを自分のプログラムファイルにコピーしておくと次回以降便利)

# データの読み込み

前回はデータを下記のように手打ちしました。

```{r}
age <- c(18, 21, 22, 23, 34) #年齢のベクトル
gender <- c("female", "male", "male", "female", "female")#性別のベクトル
dframe <- data.frame(age, gender)
```

しかし，アンケートデータや，企業の会計データ等をこのように手打ちするのは現実的ではありません。エクセル等で集計されたデータを読み込むのが一般的です。

-   例えばgoogle formsでアンケートを作成したら，googleスプレットシート（googleのエクセルみたいなもの）に自動的に集計されます。

以下では，エクセルファイルを読み込む方法についてまとめています。

## csvファイルの取り込み

エクセルで列が変数，行が観測となるようにデータを作られていることを想定します。まず，これを表計算ソフト上でcsv形式で保存します。ここでは，さんプルデータとして下のような10人の生徒の4教科の科目のテストの点数を記録したファイルを作成しています。

::: {.callout-note appearance="minimal" icon="false"}
エクセル形式で保存されたファイルも読み込めますが，余計な情報が入っていないcsvファイルの方がトラブルが少ない？
:::

![](images/Screenshot%202022-11-27%20at%2023.39.02.png)

wdに入れたファイルを読み込むには，csv形式なら，`read_csv("ファイル名")` もしくは`read.csv("ファイル名")`を使います(ファイルがとても大きいとかでなかったらどっちを使ってもあまり変わりありません)。ここでは，tests.csvと言う名前のデータを，testsと言う名前で読み込んでいます。

```{r}
#| echo: false
# setwd("~/Dropbox/2023立命館_社会調査法")
```

```{r}
#| message: false
tests <- read_csv("tests.csv")
```

読み込んだデータを見てみます。今回はいいけど，データが大きい場合など，たくさん表示されたら鬱陶しいなら最初のいくつかだけが表示される`head(データ名)`コマンドが便利です。

```{r}
head(tests)
```

## Google Driveに保存されたcsvファイルの読み込み

データをグループで共有するときなどに便利です。

1.  google driveに保存したデータを共有（リンクを知っている人全員）に設定

2.  リンクurl（`https://drive.google.com/file/d/*********/view?usp=sharing`）の\*\*\*\*\*\*\*\*の部分がidなので，その部分をメモしておく。

3.  下記の通り，idを定義して，下記の通りのコードを実行すると，目当てのファイルを取り込める。

```{r}
#| message: false

id = "1x7426qSraIRdcbgW3a0F8vMF181Q_DHF"

z = read_csv(sprintf("https://docs.google.com/uc?id=%s&export=download", id))
```

## Dropboxに保存されたcsvファイルの読み込み

google driveと基本的に同じ

1.  Dropbox上のファイルを共有，リンクを取得
2.  リンクの最後 `dl=0`を`dl=1`に変えて，`read_csv` (もしくは `read.csv`)コマンドで読み込めます

```{r}
z2 <- read_csv("https://www.dropbox.com/s/6x344sfra54mcco/tests.csv?dl=1")
```

# 参考

## パイプ演算子

tidyverseとmagrittrパッケージのパイプ演算子を使うことで，同じコマンドをより読みやすくできます。これからは断りなくこれらのパッケージの機能を使います。

### 例1

読み込んだデータ`test`の算数(math)の平均点を求めたい。普通にやると \[1.5.2 \]\[デ\]\[ータフレーム\]にあるように，`データフレーム名$列名`で指定するので

```{r}
#| output: false

mean(tests$math)
```

パイプ演算子`%$%`を使うと同じコマンドが以下のようになる

```{r}
#| output: false

tests %$%
  mean(math)
```

これだとあまり何がいいのかわかりませんが，複数の変数を指定したいときなど，いちいちデータフレーム名を指定しなくて良いので便利です。

### 例2

例1だと便利さを実感しにくいですが，例えば以下のコマンドだともう少し便利さがわかるかもしれません。以下は(1)`test`データを使って，(2)数学の点数と他の点数の関係を分析(`lm`)した上で，(3)その結果を表示する(`summary`)もの。

```{r}
#| output: false
summary(lm(math ~ japanese + physics ,data = tests))

```

日本語の順番と，コマンドの構造が反対 (結果を表示する→分析内容→データ)

全く同じことをパイプ演算子を使うと，(1) testデータで(2)分析をして(3)結果の要約を表示する，という思考の順番で書けます。

```{r}
#| output: false
tests %$%
  lm(math ~ japanese + physics) %>% 
  summary()

```

命令が複雑になる程効果が実感できます。

ちなみに`%$%`は，使うデータを指定するのに使う。`%>%`はコマンドの結果を次のコマンドに渡すのに使う。

## データの処理

分析に入る前に必要そうな処理を紹介します。

### 新しい変数の作成

現在のデータにはない，4教科の合計点が欲しい。新しい変数は`mutate()`で作る。ただし，mutateだけだと，変数を作ってどこにも保存してくれないので，保存場所を指定する必要があります。今回は元のデータに付け足す形で作ります。

```{r}
tests <- tests %>% 
  mutate(sum = math + japanese + history + physics)
```

tests に testsの中のデータを使って作った新しい変数を入れる。1行目が冗長なので，パイプ`%<>%`を使って書き直すと

```{r}
tests %<>%
  mutate(sum = math + japanese + history + physics)
```

以下も同じ

```{r}
tests %<>%
  rowwise() %>% 
  mutate(sum = sum(math, japanese, history, physics)) %>% 
  ungroup()
```
